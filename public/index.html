<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Referral Statistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        /* CSS Variables matching admin panel theme */
        :root {
            /* Gray monochrome light theme */
            --background: 0 0% 98%;
            --foreground: 0 0% 9%;
            --card: 0 0% 100%;
            --card-foreground: 0 0% 9%;
            --popover: 0 0% 100%;
            --popover-foreground: 0 0% 9%;
            --primary: 0 0% 9%;
            --primary-foreground: 0 0% 98%;
            --secondary: 0 0% 96%;
            --secondary-foreground: 0 0% 9%;
            --muted: 0 0% 96%;
            --muted-foreground: 0 0% 45%;
            --accent: 0 0% 96%;
            --accent-foreground: 0 0% 9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 0 0% 89%;
            --input: 0 0% 89%;
            --ring: 0 0% 9%;
        }

        .dark {
            /* Gray monochrome dark theme */
            --background: 0 0% 9%;
            --foreground: 0 0% 98%;
            --card: 0 0% 13%;
            --card-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 0 0% 9%;
            --secondary: 0 0% 18%;
            --muted: 0 0% 18%;
            --muted-foreground: 0 0% 63%;
            --border: 0 0% 20%;
            --input: 0 0% 20%;
            --ring: 0 0% 83%;
        }

        /* Flatpickr theme */
        .flatpickr-calendar {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .flatpickr-months {
            background: hsl(var(--card));
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: hsl(var(--card)) !important;
            color: hsl(var(--foreground)) !important;
        }
        .flatpickr-current-month input.cur-year {
            color: hsl(var(--foreground)) !important;
        }
        .flatpickr-monthDropdown-months option {
            background: hsl(var(--card)) !important;
            color: hsl(var(--foreground)) !important;
        }
        .flatpickr-monthDropdown-months:hover,
        .flatpickr-monthDropdown-months:focus,
        .flatpickr-monthDropdown-months:active {
            background: hsl(var(--card)) !important;
            color: hsl(var(--foreground)) !important;
        }
        .flatpickr-weekday {
            color: hsl(var(--muted-foreground));
        }
        .flatpickr-day {
            color: hsl(var(--foreground));
        }
        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            color: hsl(var(--muted-foreground)) !important;
            opacity: 0.4;
            cursor: not-allowed;
            background: transparent !important;
        }
        .flatpickr-day:hover:not(.flatpickr-disabled) {
            background: hsl(var(--secondary));
            border-color: hsl(var(--border));
        }
        .flatpickr-day.selected,
        .flatpickr-day.selected:hover {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border-color: hsl(var(--primary));
        }
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: hsl(var(--foreground));
            fill: hsl(var(--foreground));
        }
        .flatpickr-months .flatpickr-prev-month:hover,
        .flatpickr-months .flatpickr-next-month:hover {
            color: hsl(var(--muted-foreground));
        }
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: hsl(var(--muted-foreground)) !important;
            opacity: 0.15 !important;
            cursor: not-allowed !important;
        }
        .flatpickr-calendar .flatpickr-buttons {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid hsl(var(--border));
            background: hsl(var(--card));
        }
        .flatpickr-calendar .flatpickr-buttons button {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid hsl(var(--border));
            transition: all 0.2s;
        }
        .flatpickr-calendar .flatpickr-buttons .btn-clear {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }
        .flatpickr-calendar .flatpickr-buttons .btn-clear:hover {
            opacity: 0.8;
        }
        .flatpickr-calendar .flatpickr-buttons .btn-apply {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        .flatpickr-calendar .flatpickr-buttons .btn-apply:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen bg-background text-foreground antialiased">
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h1 id="pageTitle" class="text-3xl font-bold tracking-tight">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤</h1>
            <div class="flex gap-2">
                <button id="btnRu" onclick="setLanguage('ru')" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-blue-900 text-white hover:bg-blue-800">RU</button>
                <button id="btnEn" onclick="setLanguage('en')" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-slate-800 text-slate-400 hover:bg-slate-700">EN</button>
            </div>
        </div>

        <!-- Controls -->
        <div class="grid gap-4 md:grid-cols-4 mb-8">
            <div class="flex flex-col space-y-1.5">
                <label id="labelApiKey" class="text-sm font-medium leading-none">API Key</label>
                <input type="text" id="apiKey" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" placeholder="Enter API key">
            </div>
            <div class="flex flex-col space-y-1.5">
                <label id="labelRefCode" class="text-sm font-medium leading-none">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</label>
                <input type="text" id="refCode" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" placeholder="Enter referral code">
            </div>
            <div class="flex flex-col space-y-1.5">
                <label id="labelUserCost" class="text-sm font-medium leading-none">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ($)</label>
                <input type="number" id="userCost" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" placeholder="0.00" step="0.01" min="0" onchange="loadData()">
            </div>
            <div class="flex flex-col space-y-1.5">
                <label id="labelDateFilter" class="text-sm font-medium leading-none">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</label>
                <div class="flex gap-2">
                    <input type="text" id="dateFilter" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" readonly>
                    <button id="btnLoad" onclick="loadData()" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 bg-green-900 text-white hover:bg-green-800 whitespace-nowrap">
                        üîÑ <span id="btnLoadText" class="ml-1">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div id="error"></div>
        
        <!-- Loading -->
        <div id="loading" class="hidden text-center py-12 text-muted-foreground">Loading data...</div>

        <!-- Stats -->
        <div id="stats" class="hidden space-y-6">
            <!-- Stats Grid -->
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statUsers" class="text-sm font-medium text-muted-foreground">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div id="usersCount" class="text-3xl font-bold mt-2">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statInProgress" class="text-sm font-medium text-muted-foreground">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</h3>
                    <div id="inProgress" class="text-3xl font-bold mt-2 text-blue-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statFinished" class="text-sm font-medium text-muted-foreground">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</h3>
                    <div id="finished" class="text-3xl font-bold mt-2 text-green-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statCancelled" class="text-sm font-medium text-muted-foreground">–û—Ç–º–µ–Ω–µ–Ω–æ</h3>
                    <div id="cancelled" class="text-3xl font-bold mt-2 text-red-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statValidation" class="text-sm font-medium text-muted-foreground">–í–∞–ª–∏–¥–∞—Ü–∏—è</h3>
                    <div id="validation" class="text-3xl font-bold mt-2 text-yellow-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statScreenshot" class="text-sm font-medium text-muted-foreground">–û–¥–æ–±—Ä–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞</h3>
                    <div id="screenshotApproval" class="text-3xl font-bold mt-2 text-purple-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statConversion" class="text-sm font-medium text-muted-foreground">Conversion Rate</h3>
                    <div id="conversionRate" class="text-3xl font-bold mt-2 text-cyan-500">-</div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h3 id="statCPA" class="text-sm font-medium text-muted-foreground">CPA</h3>
                    <div id="cpaValue" class="text-3xl font-bold mt-2 text-orange-500">-</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid gap-4 md:grid-cols-2">
                <div class="rounded-lg border border-border bg-card p-6">
                    <h2 id="chartTimeline" class="text-lg font-semibold mb-4">üìà –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –∑–∞–¥–∞—á</h2>
                    <div class="h-[300px]">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="rounded-lg border border-border bg-card p-6">
                    <h2 id="chartDistribution" class="text-lg font-semibold mb-4">ü•ß –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤</h2>
                    <div class="h-[300px]">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Debug -->
            <div class="rounded-lg border border-border bg-muted p-4">
                <strong class="text-sm">üîç Debug:</strong>
                <span id="debugText" class="text-sm text-muted-foreground ml-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
            </div>
        </div>
    </div>

    <script>
        let timelineChart, pieChart;
        let currentLang = 'ru';
        let availableDates = [];
        let flatpickrInstance = null;

        // Listen for theme changes from parent admin panel
        window.addEventListener('message', (event) => {
            // Accept messages from admin panel domains
            const allowedOrigins = [
                'https://admin.aso.market',
                'https://aso-market-admin-dev.vercel.app',
                'http://localhost:5173'
            ];
            
            if (allowedOrigins.includes(event.origin) && event.data.type === 'theme') {
                const theme = event.data.theme;
                const htmlElement = document.documentElement;
                
                if (theme === 'dark') {
                    htmlElement.classList.add('dark');
                } else {
                    htmlElement.classList.remove('dark');
                }
                
                // Redraw charts with new theme
                if (timelineChart && pieChart) {
                    updateChartColors();
                }
            }
        });

        function updateChartColors() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            if (timelineChart) {
                timelineChart.options.plugins.legend.labels.color = textColor;
                timelineChart.options.scales.y.ticks.color = textColor;
                timelineChart.options.scales.y.grid.color = gridColor;
                timelineChart.options.scales.x.ticks.color = textColor;
                timelineChart.options.scales.x.grid.color = gridColor;
                timelineChart.update();
            }

            if (pieChart) {
                pieChart.options.plugins.legend.labels.color = textColor;
                pieChart.update();
            }
        }

        const translations = {
            ru: {
                pageTitle: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤',
                labelApiKey: 'API –∫–ª—é—á',
                labelRefCode: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥',
                labelUserCost: '–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ($)',
                labelDateFilter: '–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ',
                btnLoad: '–ó–∞–≥—Ä—É–∑–∏—Ç—å',
                placeholderApiKey: '–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á',
                placeholderRefCode: '–í–≤–µ–¥–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥',
                statUsers: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
                statInProgress: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
                statFinished: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                statCancelled: '–û—Ç–º–µ–Ω–µ–Ω–æ',
                statValidation: '–í–∞–ª–∏–¥–∞—Ü–∏—è',
                statScreenshot: '–û–¥–æ–±—Ä–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞',
                statConversion: 'Conversion Rate',
                statCPA: 'CPA',
                chartTimeline: 'üìà –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –∑–∞–¥–∞—á',
                chartDistribution: 'ü•ß –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤',
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
                errorKey: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥',
                errorLoad: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
                chartFinished: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                chartCancelled: '–û—Ç–º–µ–Ω–µ–Ω–æ',
                chartInProgress: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
                chartValidation: '–í–∞–ª–∏–¥–∞—Ü–∏—è',
                chartScreenshot: '–û–¥–æ–±—Ä–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞',
                btnClear: '–°–±—Ä–æ—Å',
                btnApply: '–ü—Ä–∏–º–µ–Ω–∏—Ç—å'
            },
            en: {
                pageTitle: 'üìä Referral Statistics Dashboard',
                labelApiKey: 'API Key',
                labelRefCode: 'Referral Code',
                labelUserCost: 'User Cost ($)',
                labelDateFilter: 'Date Filter',
                btnLoad: 'Load Data',
                placeholderApiKey: 'Enter API key',
                placeholderRefCode: 'Enter referral code',
                statUsers: 'Total Users',
                statInProgress: 'In Progress',
                statFinished: 'Finished',
                statCancelled: 'Cancelled',
                statValidation: 'Validation',
                statScreenshot: 'Screenshot Approval',
                statConversion: 'Conversion Rate',
                statCPA: 'CPA',
                chartTimeline: 'üìà Tasks Timeline',
                chartDistribution: 'ü•ß Task Status Distribution',
                loading: 'Loading data...',
                errorKey: 'Please provide API Key and Referral Code',
                errorLoad: 'Failed to load data',
                chartFinished: 'Finished',
                chartCancelled: 'Cancelled',
                chartInProgress: 'In Progress',
                chartValidation: 'Validation',
                chartScreenshot: 'Screenshot Approval',
                btnClear: 'Clear',
                btnApply: 'Apply'
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('pageTitle').textContent = t.pageTitle;
            document.getElementById('labelApiKey').textContent = t.labelApiKey;
            document.getElementById('labelRefCode').textContent = t.labelRefCode;
            document.getElementById('labelUserCost').textContent = t.labelUserCost;
            document.getElementById('labelDateFilter').textContent = t.labelDateFilter;
            document.getElementById('btnLoadText').textContent = t.btnLoad;
            document.getElementById('apiKey').placeholder = t.placeholderApiKey;
            document.getElementById('refCode').placeholder = t.placeholderRefCode;
            
            document.getElementById('statUsers').textContent = t.statUsers;
            document.getElementById('statInProgress').textContent = t.statInProgress;
            document.getElementById('statFinished').textContent = t.statFinished;
            document.getElementById('statCancelled').textContent = t.statCancelled;
            document.getElementById('statValidation').textContent = t.statValidation;
            document.getElementById('statScreenshot').textContent = t.statScreenshot;
            document.getElementById('statConversion').textContent = t.statConversion;
            document.getElementById('statCPA').textContent = t.statCPA;
            
            document.getElementById('chartTimeline').textContent = t.chartTimeline;
            document.getElementById('chartDistribution').textContent = t.chartDistribution;
            
            if (lang === 'ru') {
                document.getElementById('btnRu').className = "inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-blue-900 text-white hover:bg-blue-800";
                document.getElementById('btnEn').className = "inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-slate-800 text-slate-400 hover:bg-slate-700";
            } else {
                document.getElementById('btnRu').className = "inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-slate-800 text-slate-400 hover:bg-slate-700";
                document.getElementById('btnEn').className = "inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 bg-blue-900 text-white hover:bg-blue-800";
            }
            
            if (timelineChart && pieChart) {
                loadData();
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById('apiKey').value = urlParams.get('key') || '';
        document.getElementById('refCode').value = urlParams.get('refCode') || '';
        
        setLanguage('ru');

        async function loadData() {
            const apiKey = document.getElementById('apiKey').value;
            const refCode = document.getElementById('refCode').value;
            const dateFilter = document.getElementById('dateFilter').value;

            if (!apiKey || !refCode) {
                showError(translations[currentLang].errorKey);
                return;
            }

            document.getElementById('loading').textContent = translations[currentLang].loading;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('error').innerHTML = '';

            try {
                const url = `https://prod-pfvwi.ondigitalocean.app/api/users/referral-statistics?key=${apiKey}&refCode=${refCode}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let filteredStats = data.tasksStatistics;
                const totalStats = filteredStats.length;
                
                if (dateFilter) {
                    const targetDate = new Date(dateFilter).toISOString().split('T')[0];
                    filteredStats = filteredStats.filter(stat => 
                        stat.date.startsWith(targetDate)
                    );
                    
                    document.getElementById('debugText').innerHTML = `
                        –§–∏–ª—å—Ç—Ä: ${dateFilter} | –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${totalStats} | –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞: ${filteredStats.length}
                    `;
                } else {
                    document.getElementById('debugText').innerHTML = `
                        –§–∏–ª—å—Ç—Ä: –Ω–µ –ø—Ä–∏–º–µ–Ω—ë–Ω | –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${totalStats}
                    `;
                }

                displayData(data, filteredStats);
            } catch (error) {
                showError(`${translations[currentLang].errorLoad}: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayData(data, filteredStats) {
            document.getElementById('stats').classList.remove('hidden');
            
            availableDates = data.tasksStatistics
                .map(s => s.date.split('T')[0])
                .sort();
            
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
            }
            
            flatpickrInstance = flatpickr('#dateFilter', {
                dateFormat: 'Y-m-d',
                mode: 'single',
                enable: availableDates,
                locale: {
                    firstDayOfWeek: 1,
                    weekdays: {
                        shorthand: ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'],
                        longhand: ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞']
                    },
                    months: {
                        shorthand: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'],
                        longhand: ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å']
                    }
                },
                allowInput: false,
                clickOpens: true,
                onReady: function(selectedDates, dateStr, instance) {
                    setTimeout(() => instance.redraw(), 0);
                    
                    const calendar = instance.calendarContainer;
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'flatpickr-buttons';
                    
                    const t = translations[currentLang];
                    
                    const clearBtn = document.createElement('button');
                    clearBtn.className = 'btn-clear';
                    clearBtn.textContent = t.btnClear;
                    clearBtn.type = 'button';
                    clearBtn.onclick = function(e) {
                        e.preventDefault();
                        instance.clear();
                        loadData();
                    };
                    
                    const applyBtn = document.createElement('button');
                    applyBtn.className = 'btn-apply';
                    applyBtn.textContent = t.btnApply;
                    applyBtn.type = 'button';
                    applyBtn.onclick = function(e) {
                        e.preventDefault();
                        instance.close();
                        loadData();
                    };
                    
                    buttonsDiv.appendChild(clearBtn);
                    buttonsDiv.appendChild(applyBtn);
                    calendar.appendChild(buttonsDiv);
                }
            });
            
            const filteredTotal = {
                finished: filteredStats.reduce((sum, s) => sum + s.finished, 0),
                cancelled: filteredStats.reduce((sum, s) => sum + s.cancelled, 0),
                inProgress: filteredStats.reduce((sum, s) => sum + s.inProgress, 0),
                validation: filteredStats.reduce((sum, s) => sum + s.validation, 0),
                screenshotApproval: filteredStats.reduce((sum, s) => sum + s.screenshotApproval, 0)
            };
            
            document.getElementById('usersCount').textContent = data.usersCount;
            
            const totalTasks = filteredTotal.finished + filteredTotal.cancelled + filteredTotal.inProgress + filteredTotal.validation + filteredTotal.screenshotApproval;
            
            const inProgressPercent = data.usersCount > 0 ? ((filteredTotal.inProgress / data.usersCount) * 100).toFixed(2) : '0.00';
            const finishedPercent = data.usersCount > 0 ? ((filteredTotal.finished / data.usersCount) * 100).toFixed(2) : '0.00';
            const cancelledPercent = data.usersCount > 0 ? ((filteredTotal.cancelled / data.usersCount) * 100).toFixed(2) : '0.00';
            const validationPercent = data.usersCount > 0 ? ((filteredTotal.validation / data.usersCount) * 100).toFixed(2) : '0.00';
            const screenshotPercent = data.usersCount > 0 ? ((filteredTotal.screenshotApproval / data.usersCount) * 100).toFixed(2) : '0.00';
            
            document.getElementById('inProgress').innerHTML = `${filteredTotal.inProgress}<span class="text-sm font-normal ml-2 opacity-70">${inProgressPercent}%</span>`;
            document.getElementById('finished').innerHTML = `${filteredTotal.finished}<span class="text-sm font-normal ml-2 opacity-70">${finishedPercent}%</span>`;
            document.getElementById('cancelled').innerHTML = `${filteredTotal.cancelled}<span class="text-sm font-normal ml-2 opacity-70">${cancelledPercent}%</span>`;
            document.getElementById('validation').innerHTML = `${filteredTotal.validation}<span class="text-sm font-normal ml-2 opacity-70">${validationPercent}%</span>`;
            document.getElementById('screenshotApproval').innerHTML = `${filteredTotal.screenshotApproval}<span class="text-sm font-normal ml-2 opacity-70">${screenshotPercent}%</span>`;
            
            const conversionRate = data.usersCount > 0
                ? ((filteredTotal.finished / data.usersCount) * 100).toFixed(2) + '%'
                : '0.00%';
            document.getElementById('conversionRate').textContent = conversionRate;
            
            const userCost = parseFloat(document.getElementById('userCost').value) || 0;
            let cpa = '0.00';
            if (userCost > 0) {
                const totalCost = data.usersCount * userCost;
                const revenue = filteredTotal.finished * 1;
                cpa = (totalCost - revenue).toFixed(2);
            }
            document.getElementById('cpaValue').textContent = '$' + cpa;

            const dates = filteredStats.map(s => new Date(s.date).toLocaleDateString());
            const t = translations[currentLang];
            
            if (timelineChart) timelineChart.destroy();
            if (pieChart) pieChart.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: t.chartFinished,
                            data: filteredStats.map(s => s.finished),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: t.chartCancelled,
                            data: filteredStats.map(s => s.cancelled),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: t.chartInProgress,
                            data: filteredStats.map(s => s.inProgress),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: t.chartValidation,
                            data: filteredStats.map(s => s.validation),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: textColor, font: { size: 11 } }
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { color: textColor, font: { size: 14, weight: 'bold' } },
                            grid: { color: gridColor }
                        },
                        x: { 
                            ticks: { color: textColor, font: { size: 14, weight: 'bold' } },
                            grid: { color: gridColor }
                        }
                    }
                }
            });

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            
            const percentages = [
                totalTasks > 0 ? ((filteredTotal.finished / totalTasks) * 100).toFixed(1) : 0,
                totalTasks > 0 ? ((filteredTotal.cancelled / totalTasks) * 100).toFixed(1) : 0,
                totalTasks > 0 ? ((filteredTotal.inProgress / totalTasks) * 100).toFixed(1) : 0,
                totalTasks > 0 ? ((filteredTotal.validation / totalTasks) * 100).toFixed(1) : 0,
                totalTasks > 0 ? ((filteredTotal.screenshotApproval / totalTasks) * 100).toFixed(1) : 0
            ];
            
            const labelsWithPercentages = [
                `${t.chartFinished} (${percentages[0]}%)`,
                `${t.chartCancelled} (${percentages[1]}%)`,
                `${t.chartInProgress} (${percentages[2]}%)`,
                `${t.chartValidation} (${percentages[3]}%)`,
                `${t.chartScreenshot} (${percentages[4]}%)`
            ];
            
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labelsWithPercentages,
                    datasets: [{
                        data: [
                            filteredTotal.finished,
                            filteredTotal.cancelled,
                            filteredTotal.inProgress,
                            filteredTotal.validation,
                            filteredTotal.screenshotApproval
                        ],
                        backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6']
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: textColor, font: { size: 12 } },
                            position: 'right'
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                if (value === 0) return '';
                                return value;
                            }
                        }
                    }
                }
            });
        }

        function showError(message) {
            document.getElementById('error').innerHTML = `<div class="rounded-lg border border-red-500 bg-red-500/10 p-4 text-red-500 mb-4">‚ùå ${message}</div>`;
        }

        if (urlParams.get('key') && urlParams.get('refCode')) {
            loadData();
        }
    </script>
</body>
</html>